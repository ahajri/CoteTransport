{
  "name": "activator",
  "description": "simple user activation and password reset for nodejs",
  "version": "1.2.2",
  "url": "http://github.com/deitch/activator",
  "author": {
    "name": "Avi Deitcher http://github.com/deitch"
  },
  "contributors": [
    {
      "name": "Avi Deitcher",
      "url": "http://github.com/deitcher"
    },
    {
      "name": "Sharry Stowell",
      "url": "https://github.com/molinto"
    },
    {
      "name": "Bartol Karuza",
      "url": "https://github.com/bartolkaruza"
    },
    {
      "name": "Clif Gordon",
      "url": "https://github.com/ClifG"
    }
  ],
  "engines": {
    "node": ">=0.8"
  },
  "main": "./lib/activator.js",
  "dependencies": {
    "async": "0.2.x",
    "lodash": ">=4.0.0",
    "nodemailer": ">=1.3.4",
    "styliner": "^0.8.9"
  },
  "devDependencies": {
    "body-parser": "^1.12.2",
    "express": "4.x",
    "mocha": "1.x",
    "should": "7.x.x",
    "smtp-tester": "~0.5.1",
    "supertest": "0.x"
  },
  "keywords": [
    "express",
    "email",
    "sms",
    "activation",
    "nodejs",
    "node",
    "confirmation",
    "two-step"
  ],
  "scripts": {
    "test": "mocha"
  },
  "repository": {
    "type": "git",
    "url": "http://github.com/deitch/activator.git"
  },
  "bugs": {
    "url": "https://github.com/deitch/activator/issues"
  },
  "license": "MIT",
  "readme": "# Activator\n\n## Overview\nactivator is the **simple** way to handle user activation and password reset for your nodejs apps!\n\nExample:\n    \n    var express = require('express'), app = express(), activator = require('activator');\n\t\t\n\t\tactivator.init({user:userModel,transport:smtpURL,from:\"activator@github.com\",templates:mailTemplatesDir});\n\t\t\n\t\tapp.user(app.router);\n\t\t\n\t\t// activate a user\n\t\tapp.post(\"/user\",activator.createActivate);\n\t\tapp.put(\"/user/:user/active\",activator.completeActivate);\n\t\t\n\t\t// reset a password\n\t\tapp.post(\"/passwordreset\",activator.createPasswordReset);\n\t\tapp.put(\"/passwordreset/:user\",activator.completePasswordReset);\n\n## Versions\nActivator version >= 1.0.0 works **only** with express >=4.0.0\n\nActivator version <1.0.0 works **only** with express <4.0.0\n\n## Purpose\nMost interaction between users and your Web-driven service take place directly between the user and the server: log in, send a message, join a group, post an update, close a deal, etc. The user logs in by entering a username and password, and succeeds (or doesn't); the user enters a message and clicks \"post\"; etc.\n\nThere are a few key interactions - actually, mainly just two - that take place using side channels and with delays:\n\n* New user creation & activation\n* Password reset\n\nIn both of these cases, the user does something directly on the Web (or via your mobile app or API), then something happens \"on the side\", usually via email or SMS: a confirmation email is sent; a password reset token is texted; etc.\n\nThis process is quite burdensome to build into your app, since it breaks the usual \"request-response\" paradigm.\n\n*Activator* is here to make this process easier.\n\n## Process\n### Activator Services\nActivator provides express middleware that to perform user activation - create and complete - and password reset - create and complete. It handles one-time link creation, link expiry, validation and all the other parts necessary to make user activation and password reset turnkey.\n\n*activator* also does not tell you what the email you send out should look like; you just provide a template, and activator fills it in. \n\nHere are activator's steps in detail.\n\n### User Activation\nFor user creation, the steps are normally as follows:\n\n1. User creates a new account on your Web site / app\n2. System creates an \"activation email\" that contains a one-time link and sends it to the registered email\n3. User clicks on the link, thus validating the email address\n\nMost sites call steps 2-3 \"user activation\". Activator calls step 2 \"create an activation\" and step 3 \"complete an activation\".\n\nWhen you use activator, the steps are as follows:\n\n1. User creates a new account on your Web site / app\n2. You include `activator.createActivate()` as part of the creation middleware\n3. *activator* takes the user email address from the new user account, a template from the templates directory set on initialization, and the URL from initialization, creates a one-time activation key, composes an email and sends it.\n4. The user receives the email and clicks on the link\n5. You included `activator.completeActivate()` as the express middleware handler for the path in the URL\n6. *activator* checks the one-time activation key and other information against the user account, marks the account as activated\n\n\n### Password Reset\nFor password reset, the steps are normally as follows:\n\n1. User clicks \"forgot password\" on your Web site / app\n2. System creates a \"password reset email\" that contains a one-time link and sends it to the registered email for the account\n3. User clicks on the link, allowing them the opportunity to set a new password\n\nActivator calls step 2 \"create a password reset\" and step 3 \"complete a password reset\"\n\nWhen you use activator, the steps are as follows:\n\n1. User selects \"reset password\" on your Web site / app\n2. You include `activator.createPasswordReset()` as the express middleware handler for the path\n3. *activator* takes the user email address from the user account, a template from the templates directory set on initialization, and the URL from initialization, creates a one-time password reset key, composes an email and sends it.\n4. The user receives the email and clicks on the link\n5. You included `activator.completePasswordReset()` as the express middleware handler for the path in the URL\n6. *activator* checks the one-time password reset key and other information against the user account, and then allows the user to reset the password\n\n\n\n### How To Use It\nTo user *activator*, you select the routes you wish to use - activator does not impose any special routes - and use activator as middleware. Of course, you will need to tell activator how to do several things, like:\n\n* How to find a user, so it can check for the user\n* How to update a user, so it can mark the user as being activated, or that it has a temporary password reset key\n* Where to find the templates to use for activation and password reset emails\n* What URL the user should be using to activate or reset a password. The URL is included in the email, since the user normally clicks on a link.\n\nAll of these are described in greater detail below.\n\n\n## Installation\nInstallation is simple, just install the npm module:\n\n    npm install activator\n\n\n## Usage\nFirst *initialize* your activator instance, then use its methods to activate users and reset passwords\n\n### Initialization\nIn order for activator to work, it needs to be able to read your user instances and save to them. It also needs to be able to compose and send emails.\n\n    activator = require('activator');\n\t\tactivator.init(config);\n\nThe `config` object passed to `activator.init()` **must** contain the following keys:\n\n* `user`: object that allows activator to find and save a user object. See below.\n* `emailProperty`: the property of the returned user object that is the email of the recipient. Used in `user.find()`. Defaults to \"email\".\n* `transport`: string or pre-configured nodemailer transport that describes how we will send email. See below.\n* `templates`: string describing the full path to the mail templates. See below.\n* `from`: string representing the sender for all messages\n\nOptionally, config can also contain:\n\n* `id`: the property that contains the ID in a user when it is found using `find`. See below for `user.save()`\n* `attachments`: object with attachments to include in messages. See below for detailed attachment formats.\n* `styliner`: boolean that turns on styliner for template compilation\n\n\n##### user\nThe user object needs to have two methods, with the following signatures:\n\n    user.find(login,callback);\n\t\t\nWhere:\n\n* `login`: string with which the user logs in. activator doesn't care if it is an email address, a user ID, or the colour of their parrot. `user.find()` should be able to find a user based on it.\n* `callback`: the callback function that `user.find()` should call when complete. Has the signature `callback(err,data)`. If there is an error, `data` should be `null` or `undefined`; if there is no error but no users found, both `err` *and* `data` **must** be `null` (not `undefined`). If an object is found, then `data` **must** be a single JavaScript object. The `data` object should have:\n    - a property containing the user id. By default, it is named `id`, but you can override it with `config.id`.\n    - a property containing the email address. By default, it is named `email`, but you can override it with `config.emailProperty`.\n    - a property named `activation_code` if the user has a stored activation code.\n    - a property named `password_reset_code` if the user has a stored password reset code.\n    - a property named `password_reset_time` if the user has a stored password reset time.\n\nactivator also needs to be able to save a user:\n\n    user.save(id,data,callback);\n\nWhere:\n\n* `id`: ID of the user to save. \n* `data`: the data to update the user as an object, e.g.: `{activation_code: \"asqefcehe78qa\"}`\n* `callback`: the callback function that `user.save()` should call when complete. Has the signature `callback(err)`. If the save is successful, `err` **must** be `null` (not `undefined`).\n\nWhat properties will it add to the user object in `save()`?\n\n1. activation: When a new activation is created, it will save a random string to `activation_code`. For example: `user.save(\"256\",{activation_code:\"ABT678HB\"})`. When activation is complete, it will set the code to \"X\".\n2. password reset: When a new password reset is created, it will save a random string to `password_reset_code` and an integer representing the expiry at `password_reset_time`. For examle, `user.save(\"256\",{password_reset_code:\"ABT678YY\",password_reset_time:1377151862978})`. When password reset is complete, it will set the code to \"X\" and the time to 0.\n\nWhat ID does it use to save the user?\n\n* If you passed an `id` parameter to `activator.init(config)`, then it is that property of the user. For example, `activator.init({id:'uid'})` means that when activator does `user.find('me@email.com')` and the returned object contains `{uid:12345}`, then activator will save as `user.save(12345,{activation_code:\"ABFHWD\"})`\n* If you did not pass an `id` parameter, then it is the exact same search term as used in `user.find()`. else it is the search term used as `login` in `user.find(login)`. For example, if activator does `user.find('12bc5')` then it will also do `user.save('12bc5')`.\n\n\n\n##### transport\nThere are 2 ways activator can send email: SMTP (default) or a passed-in transport.\n\n###### SMTP\nIf you are using SMTP - which is the default - all you need to pass in is a string describing how activator should connect with your mail server. It is structured as follows:\n\n    protocol://user:pass@hostname:port/domain?secureConnection=true\n\t\t\n* `protocol`: normally \"smtp\", can be \"smtps\"\n* `user`: the user with which to login to the SMTP server, if authentication is required.\n* `pass`: the password with which to login to the SMTP server, if authentication is required.\n* `hostname`: the hostname of the server, e.g. \"smtp.gmail.com\".\n* `port`: the port to use.\n* `domain`: the domain from which the mail is sent, when the mail server is first connected to.\n* `secureConnection`: the use of SSL can be guided by the query parameter \"secureConnection=true\".\n\n###### Other\nIf you prefer a different service - or you want to override the SMTP configuration - then instead of passing a URL string to transport, you can pass in a preconfigured nodemailer transport object. Since activator uses nodemailer under the covers, the transport is a pass-through.\n\nAnd, yes, you can even use the nodemailer SMTP transport instead of a URL string, if you prefer. Once activator receives a configured transport object, rather than a string, it doesn't care what it is as long as it works.\n\nHow would you do it? Well, SMTP would normally look like this:\n\n    activator.init({transport:\"smtp://user:pass@mysmtp.com/me.com\"});\n\t\t\nOr similar. \n\nTo use a pre-configured transport, you need to:\n\n1. Include the transport module\n2. Configure the transport\n3. Initialize activator with the transport\n\nHere is an SMTP example:\n\n    var smtpTransport = require('nodemailer-smtp-transport'), mailer = require('nodemailer');\n\t\tvar transport = mailer.createTransport(smtpTransport(options));\n\t\tactivator.init({transport:transport});\n\t\t\nOf course, because the 'nodemailer-smtp-transport' is the default in nodemailer, the above example is **identical** to just passing in a URL string, but you can work whichever way works for you.\n\nHere is an Amazon Simple Email Service (SES) example:\n\n    var sesTransport = require('nodemailer-ses-transport'), mailer = require('nodemailer');\n\t\tvar transport = mailer.createTransport(sesTransport(options));\n\t\tactivator.init({transport:transport});\n\t\t\nIn all cases, it is up to *you* to set the `options` to create the transport.\n\nAnd if all you know (or want to know) is SMTP, then just use the default SMTP connection with a URL string.\n\nFor details aboute nodemailer's transports, see the nodemailer transports at http://www.nodemailer.com/#available-transports\n\n##### templates\nThe directory where you keep text files that serve as mail templates. See below under the section templates.\n\n##### attachments\nThe initialization object property `attachments` is an object with 0, 1 or 2 keys:\n\n* `activate`: the attachment to add to activation messages\n* `passwordreset`: the attachment to add to password reset messages\n\nThe value for each of these attachments is an object matching the `attachments` object format from https://github.com/andris9/Nodemailer#attachments\n\n##### styliner\nThe boolean value for the initialization object property styliner specifies whether the [styliner](http://styliner.slaks.net/) libary should be used to compile your html templates. This libary provides inlining of css styles from `<style>` tags for better Gmail support. \n\n### Responses and Your Handlers\nAll of the middleware available in activator can function in one of two modes:\n\n1. Send responses - this is usually used by Ajax, e.g. `res.send(200,\"success\")` or `res.send(401,\"invalidcode\")`\n2. Pass responses - pass the responses on to your middleware, where you can do what you wish\n\n\nHere are two examples, one of each:\n\n````JavaScript\napp.post(\"/users\",createUser,activator.createActivate);\t\t// will send the success/error directly\napp.post(\"/users\",createUser,activator.createActivateNext,handler);\t\t// will call next() when done\n````\n\nWhen the middleware is done, if it ends in \"Next\", it will store the results in a `req.activator` object and then call `next()`.\n\n````JavaScript\nreq.activator = {\n\tcode: 500,\t\t\t\t\t\t\t\t// or 401 or 400 or 201 or 200 or ....\n\tmessage: \"uninitialized\"\t// of null/undefined, or \"invalidcode\" or ....\n}\n````\n\n\n### Activation\nActivation is the two-step process wherein a user first *creates* their account and *then* confirms (or activates) it by clicking on a link in an email or entering a short code via SMS/iMessage/etc.\n\nactivator provides the route handlers to create the activation code on the account and send the email, and then confirm the entered code to mark the user activated.\n\nactivator does **not** create the user; it leaves that up to you, since everyone likes to do it just a little differently.\n\n\n#### Create an activation\nActivation is simple, just add the route handler *after* you have created the user:\n\n````JavaScript\napp.post(\"/users\",createUser,activator.createActivate); \t\t\t\t\t\t\t\t// direct send() mode\napp.post(\"/users\",createUser,activator.createActivateNext,handler); \t\t// save results in req.activator and call next() mode\n````\n\n`activator.createActivate` needs access to several pieces of data in order to do its job:\n\n* `id`: It needs the ID of the user, so that it can call `user.save(id,data)`\n* `response.body`: Since `createUser` (in the above example) or anything you have done to create a user might actually want to send data back, `createActivate()` needs to be able to know what the body you want to send is, when it is successful and calls `res.send(201,data);`\n\n`createActivate()` will look for these properties on `req.activator`. \n\n````JavaScript\nreq.activator = {\n\tid: \"12345tg\", // the user ID to pass to createActivate()\n\tbody: \"A message\" // the body to send back along with the successful 201\n}\n````\n\nIf `createActivate()` or `createActivateNext()` cannot find `req.activator.id` or `req.user.id`, it will incur a `500` error.\n\n\n#### Complete an activation\nOnce the user actually clicks on the link, you need to complete the activation:\n\n````JavaScript\napp.put(\"/users/:user/activation\",activator.completeActivate);\t\t\t\t\t\t\t\t// direct res.send() mode\napp.put(\"/users/:user/activation\",activator.completeActivateNext,handler);\t\t// save results and call next() mode\n````\n\nactivator will return a `200` if successful, a `400` if there is an error, along with error information, and a `404` if it cannot find that user.\n\nactivator assumes the following:\n\n1. The express parameter `user` (i.e. `/users/:user/whatever/foo`) contains the user identifier to pass to `user.find()` as the first parameter. It will retrieve it using `req.param('user')`\n2. The `req.body` or `req.query` will contain the parameter `code` which has the actual activation code. It will retrieve it using `req.param('code')`\n\nIf it is successful activating, it will return `200`, a `400` if there is an error (including invalid activation code), and a `404` if the user cannot be found.\n\n### Password Reset\nPassword reset is a two-step process in which the user requests a password reset link, normally delivered by email, and then uses that link to set a new password. Essentially, the user requests a time-limited one-time code that is delivered to the user and allows them to set a new password.\n\n#### Create a password reset\nCreating a password reset is simple, just add the route handler:\n\n````JavaScript\napp.post(\"/passwordreset\",activator.createPasswordReset);\t\t\t\t\t\t\t// direct res.send() mode\napp.post(\"/passwordreset\",activator.createPasswordResetNext,handler);\t// save data and call next() mode\n````\n\nWhen done, activator will return a `201` code and a message whose text content is the URL to be used to reset the password.\n\nActivator assumes that the login/email/ID to search for will be in `req.param(\"user\")`.\n\n#### Complete a password reset\nOnce the user actually clicks on the link, you need to complete the password reset:\n\n````JavaScript\napp.put(\"/users/:user/passwordreset\",activator.completePasswordReset);\t\t\t\t\t\t\t\t// direct res.send() mode\napp.put(\"/users/:user/passwordreset\",activator.completePasswordResetNext,handler);\t\t// save response and call next() mode\n````\n\nactivator will return a `200` if successful, a `400` if there is an error, along with error information, and a `404` if it cannot find that user.\n\nactivator assumes the following:\n\n1. The express parameter `user` (i.e. `/users/:user/whatever/foo`) contains the user identifier to pass to `user.find()` as the first parameter. It will retrieve it using `req.param('user')`\n2. The `req.body` or `req.query` will contain the parameter `code` which has the actual password reset code, and the parameter `password` which is the new password to set. It will retrieve them using `req.param('code')` and `req.param('password')`.\n\nIf it is successful resetting the password, it will return `200`, a `400` if there is an error (including invalid code), and a `404` if the user cannot be found.\n\n\n### Templates\nIn order to send an email (yes, we are thinking about SMS for the future), activator needs to have templates. The templates are simple text files that contain the text or HTML to send.\n\nThe templates should be in the directory passed to `activator.init()` as the option `templates`. It **must** be an absolute directory path (how else is activator going to know, relative to what??). Each template file should be named according to its function: \"activate\" or \"passwordreset\". You can, optionally, add \".txt\" to the end of the filename, if it makes your life easier.\n\nEach template file must have 3 or more lines. The first line is the `Subject` of the email; the second is ignored (I like to use '-----', but whatever works for you), the third and all other lines are the content of the email.\n\nRemember, activator is a *server-side* product, so it really has no clue if the page the user should go to is https://myserver.com/funny/page/activate/fooooo.html or something a little more sane like https://myserver.com/activate.html\n\nHow does activator know what to put in the email? **It doesn't; you do!**. You put the URL in the template files for passwordreset and activate. \n\nWhat you can do is have activator embed the necessary information into the templates before sending the email. Each template file follows a simplified [EJS](http://embeddedjs.com) style (very similar to PHP). All you need to do is embed the following anywhere (and as many times as you want) inside the template:\n\n    <%= abc %>\n\t\t\nand every such instance will be replaced by the value of `abc`. So if `abc = \"John\"`, then \n\n    This is an email for <%= abc %>, \n\t\t   hi there <%= abc %>.\n\nWill be turned into\n\n    This is an email for John,\n\t\t   hi there John.\n\t\t\t \nSo what variables are available inside the templates?\n\n* `code`: the activation or password reset code\n* `email`: the email of the recipient user\n* `id`: the internal user ID of the user\n* `request`: the `request` object that was passed to the route handler, from which you can extract lots of headers, for example the protocol at `req.protocol` or the hostname from `req.headers.host`. \n\nSo if your password reset page is on the same host and protocol as the request that came in but at \"/reset/my/password\", and you want to include the code in the URL as part of a query but also add it to the page, you could do:\n\n\n    Hello,\n\t\t\n\t\tYou have asked to reset your password for MySite. To reset your password, please click on the following link:\n\t\t\n\t\t<%= request.protocol %><%= request.headers.host %>/reset/my/password?code=<%= code %>&user=<%= id %>\n\t\t\n\t\tOr just copy and paste that link and enter your code as <%= code %>.\n\t\t\n\t\tThanks! \n\t\tFrom: the MySite team\n\n\n\n#### HTML and text templates\nTemplate files can be either text or HTML. If activator finds html, it will send html email; if activator finds text, it will send text email; if it finds both, it will send both in an email.\n\nHow does it know which? Simple: **filename extension**.\n\n* `activate.html` - use this as an HTML template for activation\n* `passwordreset.html` - use this as an HTML template for password reset\n* `activate.txt` - use this as a text template for activation\n* `passwordreset.txt` - use this as a text template for password reset\n* `activate` - use this as a text template for activation\n* `passwordreset` - use this as a text template for password reset\n\nNotice that there are two options for text templates: no filename extension (e.g. `activate`) and text extension (e.g. `activate.txt`). How does it know which one to use when both are there? Simple:\n\n1. Use the filename without an extension. If it does not exist:\n2. Use the filename with the `.txt` extension.\n\nThe content format of both kinds of templates (html and text) is the same as described above and have all of the same variables.\n\n\n#### Localized templates\n\nActivator supports localized templates. You can have one template for the locale `en_GB`, a separate one for `fr` and a third for `he_IL`. Just create the files with the correct name as an extension: filename type (e.g. `activate`), followed by `_` followed by the locale string (e.g. `en_GB` or `fr`) following by the optional filetype extension (nothing or `.txt` or `.html`).\n\nHere are some examples:\n\n* `activate_en_GB.txt` - text template for locale `en_GB`\n* `activate_en_GB` - text template for locale `en_GB`\n* `activate_en_GB.html` - html template for locale `en_GB`\n* `activate_fr.html` - html template for locale `fr`, will be used when the language is `fr` or `fr_`*anything* that is not matched\n* `activate` - fallback for all unmatched locales\n\nThe search pattern is as follows.\n\n1. Look for an exact match of the locale, e.g. for `en_GB`, look for `activate_en_GB`\n2. Look for a language match, e.g. for `en_GB`, look for `activate_en`\n3. Look for a default file, e.g. for `en_GB`, look for `activate`\n\nHow does it know which language to use? Simple, just set it on `req.lang`. You might have retrieved that from your user preferences, or from your application's default, or perhaps from the http header `Accept-Language`. Either way, you should set it in earlier middleware:\n\n````JavaScript\n\t\tapp.use(function(req,res,next){\n\t\t\treq.lang = myLang; // Set your lang here\n\t\t});\n\t\tapp.use(app.router);\n\t\tapp.post('/users',activator.createActivate); // etc.\n````\n\n\n\n\n\n\n\n## Example\nAn example - just a simplified and stripped down version of the tests - is available in `./example.js`. It can be run via `node ./example.js`\n\n## Testing\nTo run the tests, from the root directory, run `npm test`.\n\n## License\nReleased under the MIT License. \nCopyright Avi Deitcher https://github.com/deitch\n",
  "readmeFilename": "README.md",
  "homepage": "https://github.com/deitch/activator",
  "_id": "activator@1.2.2",
  "_shasum": "96bf2446e735a8f9eaf0b3d9782d2f3d3bfa10e7",
  "_from": "activator@",
  "_resolved": "https://registry.npmjs.org/activator/-/activator-1.2.2.tgz"
}
